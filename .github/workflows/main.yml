name: main

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, linux]
    outputs:
      image: ${{ steps.set-image.outputs.image }}
      push_latest: ${{ steps.prepare.outputs.push_latest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare tags
        id: prepare
        # prepare SHORT_SHA and decide whether to push latest
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH" = "main" ]; then
            echo "push_latest=1" >> $GITHUB_OUTPUT
          else
            echo "push_latest=0" >> $GITHUB_OUTPUT
          fi

      - name: Show runner info (debug)
        run: |
          echo "Runner: $(hostname)"
          docker --version || true
          docker info || true

      - name: Login to Docker Hub (for local tagging if needed)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          # Build image with short sha tag
          docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}" .

      - name: Save image to tar
        run: |
          docker save -o image.tar "${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-tar
          path: image.tar

      - name: Set image output
        id: set-image
        run: |
          echo "image=${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}" >> $GITHUB_OUTPUT

  push:
    needs: build
    runs-on: [self-hosted, linux]

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: image-tar
          path: .

      - name: Show runner info (debug)
        run: |
          echo "Runner: $(hostname)"
          docker --version || true
          docker info || true

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Load docker image from tar
        run: docker load -i image.tar

      - name: Push image (sha tag)
        run: |
          docker push "${{ needs.build.outputs.image }}"

      - name: Tag and push latest (only on main)
        if: needs.build.outputs.push_latest == '1'
        run: |
          IMAGE_FULL="${{ needs.build.outputs.image }}"
          REPO="${IMAGE_FULL%:*}"
          docker tag "${IMAGE_FULL}" "${REPO}:latest"
          docker push "${REPO}:latest"

      - name: Output pushed image names
        run: |
          echo "Pushed image: ${{ needs.build.outputs.image }}"
          if [ "${{ needs.build.outputs.push_latest }}" = "1" ]; then
            echo "Pushed image: ${REPO}:latest"
          fi
