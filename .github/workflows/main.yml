name: main

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: [dockermachine]
    outputs:
      image: ${{ steps.set-image.outputs.image }}
      push_latest: ${{ steps.prepare.outputs.push_latest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare tags (do it before cleaning)
        id: prepare
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH" = "main" ]; then
            echo "push_latest=1" >> $GITHUB_OUTPUT
          else
            echo "push_latest=0" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}

      - name: Clean previous images of this repo only
        run: |
          # remove only images with repo ${DOCKERHUB_USERNAME}/s4s_cv except current tag
          echo "Cleaning previous images for ${DOCKERHUB_USERNAME}/s4s_cv except ${DOCKERHUB_USERNAME}/s4s_cv:${SHORT_SHA}"
          set -o pipefail || true
          IMAGE_PREFIX="${DOCKERHUB_USERNAME}/s4s_cv:"
          CURRENT_TAG="${IMAGE_PREFIX}${SHORT_SHA}"
          docker images --format '{{.Repository}}:{{.Tag}}' \
            | grep "^${IMAGE_PREFIX}" || true \
            | grep -v -x "${CURRENT_TAG}" || true \
            | xargs -r docker rmi -f || true
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ env.SHORT_SHA }}

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub (needed for cache push/pull)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image with buildx and registry cache
        run: |
          SHORT_SHA=${SHORT_SHA:-${GITHUB_SHA::8}}
          IMAGE="${DOCKERHUB_USERNAME}/s4s_cv:${SHORT_SHA}"
          CACHE_REF="${DOCKERHUB_USERNAME}/s4s_cv:buildcache"
          echo "Building ${IMAGE}, using cache ${CACHE_REF}"
          # buildx: use registry cache backend (stores cache as an image CACHE_REF)
          docker buildx build \
            --tag "${IMAGE}" \
            --cache-from "type=registry,ref=${CACHE_REF}" \
            --cache-to "type=registry,ref=${CACHE_REF},mode=max,push=true" \
            --load \
            .
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ env.SHORT_SHA }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Save image to workspace
        run: |
          IMAGE="${DOCKERHUB_USERNAME}/s4s_cv:${SHORT_SHA}"
          docker save -o "$GITHUB_WORKSPACE/image.tar" "$IMAGE"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ env.SHORT_SHA }}

      - name: Set image output (robust)
        id: set-image
        run: |
          SHORT_SHA="${SHORT_SHA:-${GITHUB_SHA::8}}"
          IMAGE="${DOCKERHUB_USERNAME}/s4s_cv:${SHORT_SHA}"
          echo "IMAGE_DEBUG=$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ env.SHORT_SHA }}
          GITHUB_SHA: ${{ github.sha }}

      - name: Persist image name to workspace (workaround for job-output propagation)
        run: |
          echo "${DOCKERHUB_USERNAME}/s4s_cv:${SHORT_SHA}" > "$GITHUB_WORKSPACE/image-name.txt"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          SHORT_SHA: ${{ env.SHORT_SHA }}

      - name: Prune buildx builder cache (keep recent + cap local storage)
        run: |
          # keep cache used in the last 7 days, and cap local builder storage to ~10GiB
          # this prevents unbounded local growth on the runner
          docker buildx prune --filter "until=168h" --keep-storage 10737418240 --force --all || true

  push:
    needs: build
    runs-on: [dockermachine]
    steps:
      - name: Show runner info
        run: |
          echo "Runner: $(hostname)"
          docker --version
          docker info

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Load Docker image from previous job
        run: docker load -i "$GITHUB_WORKSPACE/image.tar"

      - name: Read image name from workspace and push
        run: |
          IMAGE=$(cat "$GITHUB_WORKSPACE/image-name.txt")
          echo "IMAGE from file: $IMAGE"
          docker push "$IMAGE"

      - name: Tag and push latest (only on main)
        if: needs.build.outputs.push_latest == '1'
        run: |
          IMAGE=$(cat "$GITHUB_WORKSPACE/image-name.txt")
          REPO="${IMAGE%:*}"
          docker tag "$IMAGE" "${REPO}:latest"
          docker push "${REPO}:latest"
