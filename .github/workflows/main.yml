name: main

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: [local, faxmachine]
    outputs:
      image: ${{ steps.set-image.outputs.image }}
      push_latest: ${{ steps.prepare.outputs.push_latest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean previous Docker images
        run: |
          echo "Cleaning previous Docker images from this workflow..."
          IMAGE_PATTERN="${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:*"
          EXISTING_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${IMAGE_PATTERN}" || true)
          if [ -n "$EXISTING_IMAGES" ]; then
            echo "$EXISTING_IMAGES" | xargs docker rmi -f || true
          else
            echo "No old images to remove"
          fi
          
      - name: Free up Docker space
        run: |
          echo "Cleaning unused Docker data..."
          docker system prune -af
          # docker volume prune -f

      - name: Prepare tags
        id: prepare
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH" = "main" ]; then
            echo "push_latest=1" >> $GITHUB_OUTPUT
          else
            echo "push_latest=0" >> $GITHUB_OUTPUT
          fi

      - name: Show runner info
        run: |
          echo "Runner: $(hostname)"
          docker --version
          docker info

      - name: Build Docker image
        run: |
          docker build -t "${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}" .

      - name: Save image to tar
        run: docker save -o image.tar "${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-tar
          path: image.tar

      - name: Set image output
        id: set-image
        run: |
          echo "image=${{ secrets.DOCKERHUB_USERNAME }}/s4s_cv:${SHORT_SHA}" >> $GITHUB_OUTPUT

  push:
    needs: build
    runs-on: [local, faxmachine]
    steps:
      - name: Show runner info
        run: |
          echo "Runner: $(hostname)"
          docker --version
          docker info

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: image-tar
          path: .

      - name: Load Docker image from tar
        run: docker load -i image.tar

      - name: Push SHA image
        run: docker push "${{ needs.build.outputs.image }}"

      - name: Tag and push latest (only on main)
        if: needs.build.outputs.push_latest == '1'
        run: |
          IMAGE="${{ needs.build.outputs.image }}"
          REPO="${IMAGE%:*}"
          docker tag "$IMAGE" "${REPO}:latest"
          docker push "${REPO}:latest"

      - name: Output pushed image names
        run: |
          echo "Pushed image: ${{ needs.build.outputs.image }}"
          if [ "${{ needs.build.outputs.push_latest }}" = "1" ]; then
            echo "Pushed image: ${REPO}:latest"
          fi
